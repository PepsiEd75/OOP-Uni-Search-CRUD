"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.packagerRebuildHook = exports.listrCompatibleRebuildHook = void 0;
var cp = _interopRequireWildcard(require("child_process"));
var path = _interopRequireWildcard(require("path"));
var _asyncOra = require("@electron-forge/async-ora");
var _rebuild = require("@electron/rebuild");
function _interopRequireWildcard(obj) {
    if (obj && obj.__esModule) {
        return obj;
    } else {
        var newObj = {};
        if (obj != null) {
            for(var key in obj){
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};
                    if (desc.get || desc.set) {
                        Object.defineProperty(newObj, key, desc);
                    } else {
                        newObj[key] = obj[key];
                    }
                }
            }
        }
        newObj.default = obj;
        return newObj;
    }
}
const listrCompatibleRebuildHook = async (buildPath, electronVersion, platform, arch, config = {}, task)=>{
    var ref, ref1;
    task.title = 'Preparing native dependencies';
    const options = {
        ...config,
        buildPath,
        electronVersion,
        arch
    };
    const child = cp.fork(path.resolve(__dirname, 'remote-rebuild.js'), [
        JSON.stringify(options)
    ], {
        stdio: [
            'pipe',
            'pipe',
            'pipe',
            'ipc'
        ]
    });
    let pendingError;
    let found = 0;
    let done = 0;
    const redraw = ()=>{
        task.title = `Preparing native dependencies: ${done} / ${found}`;
    };
    (ref = child.stdout) === null || ref === void 0 ? void 0 : ref.on('data', (chunk)=>{
        task.output = chunk.toString();
    });
    (ref1 = child.stderr) === null || ref1 === void 0 ? void 0 : ref1.on('data', (chunk)=>{
        task.output = chunk.toString();
    });
    child.on('message', (message)=>{
        switch(message.msg){
            case 'module-found':
                {
                    found += 1;
                    redraw();
                    break;
                }
            case 'module-done':
                {
                    done += 1;
                    redraw();
                    break;
                }
            case 'rebuild-error':
                {
                    pendingError = new Error(message.err.message);
                    pendingError.stack = message.err.stack;
                    break;
                }
            case 'rebuild-done':
                {
                    task.task.rendererTaskOptions.persistentOutput = false;
                    break;
                }
        }
    });
    await new Promise((resolve, reject)=>{
        child.on('exit', (code)=>{
            if (code === 0 && !pendingError) {
                resolve();
            } else {
                reject(pendingError || new Error(`Rebuilder failed with exit code: ${code}`));
            }
        });
    });
};
exports.listrCompatibleRebuildHook = listrCompatibleRebuildHook;
const packagerRebuildHook = async (buildPath, electronVersion, _platform, arch, config = {})=>{
    await (0, _asyncOra).asyncOra('Preparing native dependencies', async (rebuildSpinner)=>{
        const rebuilder = (0, _rebuild).rebuild({
            ...config,
            buildPath,
            electronVersion,
            arch
        });
        const { lifecycle  } = rebuilder;
        let found = 0;
        let done = 0;
        const redraw = ()=>{
            rebuildSpinner.text = `Preparing native dependencies: ${done} / ${found}`;
        };
        lifecycle.on('module-found', ()=>{
            found += 1;
            redraw();
        });
        lifecycle.on('module-done', ()=>{
            done += 1;
            redraw();
        });
        await rebuilder;
    });
};
exports.packagerRebuildHook = packagerRebuildHook;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWJ1aWxkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgYXN5bmNPcmEgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCB7IEZvcmdlQXJjaCwgRm9yZ2VMaXN0clRhc2ssIEZvcmdlUGxhdGZvcm0gfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCB7IHJlYnVpbGQsIFJlYnVpbGRPcHRpb25zIH0gZnJvbSAnQGVsZWN0cm9uL3JlYnVpbGQnO1xuXG5leHBvcnQgY29uc3QgbGlzdHJDb21wYXRpYmxlUmVidWlsZEhvb2sgPSBhc3luYyAoXG4gIGJ1aWxkUGF0aDogc3RyaW5nLFxuICBlbGVjdHJvblZlcnNpb246IHN0cmluZyxcbiAgcGxhdGZvcm06IEZvcmdlUGxhdGZvcm0sXG4gIGFyY2g6IEZvcmdlQXJjaCxcbiAgY29uZmlnOiBQYXJ0aWFsPFJlYnVpbGRPcHRpb25zPiA9IHt9LFxuICB0YXNrOiBGb3JnZUxpc3RyVGFzazxhbnk+XG4pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdGFzay50aXRsZSA9ICdQcmVwYXJpbmcgbmF0aXZlIGRlcGVuZGVuY2llcyc7XG5cbiAgY29uc3Qgb3B0aW9uczogUmVidWlsZE9wdGlvbnMgPSB7XG4gICAgLi4uY29uZmlnLFxuICAgIGJ1aWxkUGF0aCxcbiAgICBlbGVjdHJvblZlcnNpb24sXG4gICAgYXJjaCxcbiAgfTtcblxuICBjb25zdCBjaGlsZCA9IGNwLmZvcmsocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ3JlbW90ZS1yZWJ1aWxkLmpzJyksIFtKU09OLnN0cmluZ2lmeShvcHRpb25zKV0sIHtcbiAgICBzdGRpbzogWydwaXBlJywgJ3BpcGUnLCAncGlwZScsICdpcGMnXSxcbiAgfSk7XG5cbiAgbGV0IHBlbmRpbmdFcnJvcjogdW5rbm93bjtcbiAgbGV0IGZvdW5kID0gMDtcbiAgbGV0IGRvbmUgPSAwO1xuXG4gIGNvbnN0IHJlZHJhdyA9ICgpID0+IHtcbiAgICB0YXNrLnRpdGxlID0gYFByZXBhcmluZyBuYXRpdmUgZGVwZW5kZW5jaWVzOiAke2RvbmV9IC8gJHtmb3VuZH1gO1xuICB9O1xuXG4gIGNoaWxkLnN0ZG91dD8ub24oJ2RhdGEnLCAoY2h1bmspID0+IHtcbiAgICB0YXNrLm91dHB1dCA9IGNodW5rLnRvU3RyaW5nKCk7XG4gIH0pO1xuICBjaGlsZC5zdGRlcnI/Lm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgdGFzay5vdXRwdXQgPSBjaHVuay50b1N0cmluZygpO1xuICB9KTtcblxuICBjaGlsZC5vbignbWVzc2FnZScsIChtZXNzYWdlOiBhbnkpID0+IHtcbiAgICBzd2l0Y2ggKG1lc3NhZ2UubXNnKSB7XG4gICAgICBjYXNlICdtb2R1bGUtZm91bmQnOiB7XG4gICAgICAgIGZvdW5kICs9IDE7XG4gICAgICAgIHJlZHJhdygpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ21vZHVsZS1kb25lJzoge1xuICAgICAgICBkb25lICs9IDE7XG4gICAgICAgIHJlZHJhdygpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ3JlYnVpbGQtZXJyb3InOiB7XG4gICAgICAgIHBlbmRpbmdFcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlLmVyci5tZXNzYWdlKTtcbiAgICAgICAgKHBlbmRpbmdFcnJvciBhcyBhbnkpLnN0YWNrID0gbWVzc2FnZS5lcnIuc3RhY2s7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAncmVidWlsZC1kb25lJzoge1xuICAgICAgICB0YXNrLnRhc2sucmVuZGVyZXJUYXNrT3B0aW9ucy5wZXJzaXN0ZW50T3V0cHV0ID0gZmFsc2U7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgYXdhaXQgbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNoaWxkLm9uKCdleGl0JywgKGNvZGUpID0+IHtcbiAgICAgIGlmIChjb2RlID09PSAwICYmICFwZW5kaW5nRXJyb3IpIHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVqZWN0KHBlbmRpbmdFcnJvciB8fCBuZXcgRXJyb3IoYFJlYnVpbGRlciBmYWlsZWQgd2l0aCBleGl0IGNvZGU6ICR7Y29kZX1gKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufTtcblxuZXhwb3J0IGNvbnN0IHBhY2thZ2VyUmVidWlsZEhvb2sgPSBhc3luYyAoXG4gIGJ1aWxkUGF0aDogc3RyaW5nLFxuICBlbGVjdHJvblZlcnNpb246IHN0cmluZyxcbiAgX3BsYXRmb3JtOiBGb3JnZVBsYXRmb3JtLFxuICBhcmNoOiBGb3JnZUFyY2gsXG4gIGNvbmZpZzogUGFydGlhbDxSZWJ1aWxkT3B0aW9ucz4gPSB7fVxuKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGF3YWl0IGFzeW5jT3JhKCdQcmVwYXJpbmcgbmF0aXZlIGRlcGVuZGVuY2llcycsIGFzeW5jIChyZWJ1aWxkU3Bpbm5lcikgPT4ge1xuICAgIGNvbnN0IHJlYnVpbGRlciA9IHJlYnVpbGQoe1xuICAgICAgLi4uY29uZmlnLFxuICAgICAgYnVpbGRQYXRoLFxuICAgICAgZWxlY3Ryb25WZXJzaW9uLFxuICAgICAgYXJjaCxcbiAgICB9KTtcbiAgICBjb25zdCB7IGxpZmVjeWNsZSB9ID0gcmVidWlsZGVyO1xuXG4gICAgbGV0IGZvdW5kID0gMDtcbiAgICBsZXQgZG9uZSA9IDA7XG5cbiAgICBjb25zdCByZWRyYXcgPSAoKSA9PiB7XG4gICAgICByZWJ1aWxkU3Bpbm5lci50ZXh0ID0gYFByZXBhcmluZyBuYXRpdmUgZGVwZW5kZW5jaWVzOiAke2RvbmV9IC8gJHtmb3VuZH1gO1xuICAgIH07XG5cbiAgICBsaWZlY3ljbGUub24oJ21vZHVsZS1mb3VuZCcsICgpID0+IHtcbiAgICAgIGZvdW5kICs9IDE7XG4gICAgICByZWRyYXcoKTtcbiAgICB9KTtcbiAgICBsaWZlY3ljbGUub24oJ21vZHVsZS1kb25lJywgKCkgPT4ge1xuICAgICAgZG9uZSArPSAxO1xuICAgICAgcmVkcmF3KCk7XG4gICAgfSk7XG5cbiAgICBhd2FpdCByZWJ1aWxkZXI7XG4gIH0pO1xufTtcbiJdLCJuYW1lcyI6WyJjcCIsInBhdGgiLCJsaXN0ckNvbXBhdGlibGVSZWJ1aWxkSG9vayIsImJ1aWxkUGF0aCIsImVsZWN0cm9uVmVyc2lvbiIsInBsYXRmb3JtIiwiYXJjaCIsImNvbmZpZyIsInRhc2siLCJjaGlsZCIsInRpdGxlIiwib3B0aW9ucyIsImZvcmsiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsInN0ZGlvIiwicGVuZGluZ0Vycm9yIiwiZm91bmQiLCJkb25lIiwicmVkcmF3Iiwic3Rkb3V0Iiwib24iLCJjaHVuayIsIm91dHB1dCIsInRvU3RyaW5nIiwic3RkZXJyIiwibWVzc2FnZSIsIm1zZyIsIkVycm9yIiwiZXJyIiwic3RhY2siLCJyZW5kZXJlclRhc2tPcHRpb25zIiwicGVyc2lzdGVudE91dHB1dCIsIlByb21pc2UiLCJyZWplY3QiLCJjb2RlIiwicGFja2FnZXJSZWJ1aWxkSG9vayIsIl9wbGF0Zm9ybSIsImFzeW5jT3JhIiwicmVidWlsZFNwaW5uZXIiLCJyZWJ1aWxkZXIiLCJyZWJ1aWxkIiwibGlmZWN5Y2xlIiwidGV4dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBWUEsR0FBRSxDQUFGQSxFQUFFO0FBQ0ZDLEdBQUksQ0FBSkEsSUFBSTtBQUVTLEdBQTJCLENBQTNCLFNBQTJCO0FBRVosR0FBbUIsQ0FBbkIsUUFBbUI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFcEQsS0FBSyxDQUFDQywwQkFBMEIsVUFDckNDLFNBQWlCLEVBQ2pCQyxlQUF1QixFQUN2QkMsUUFBdUIsRUFDdkJDLElBQWUs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