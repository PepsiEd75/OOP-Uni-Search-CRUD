"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "StartOptions", {
    enumerable: true,
    get: function() {
        return _sharedTypes.StartOptions;
    }
});
exports.default = void 0;
var _childProcess = require("child_process");
var _coreUtils = require("@electron-forge/core-utils");
var _sharedTypes = require("@electron-forge/shared-types");
var _chalk = _interopRequireDefault(require("chalk"));
var _debug = _interopRequireDefault(require("debug"));
var _listr2 = require("listr2");
var _electronExecutable = _interopRequireDefault(require("../util/electron-executable"));
var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));
var _hook = require("../util/hook");
var _readPackageJson = require("../util/read-package-json");
var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));
function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const d = (0, _debug).default('electron-forge:start');
var _default = async ({ dir: providedDir = process.cwd() , appPath ='.' , interactive =false , enableLogging =false , args =[] , runAsNode =false , inspect =false , inspectBrk =false  })=>{
    const platform = process.env.npm_config_platform || process.platform;
    const arch = process.env.npm_config_arch || process.arch;
    const listrOptions = {
        concurrent: false,
        rendererOptions: {
            collapseErrors: false
        },
        rendererSilent: !interactive,
        rendererFallback: Boolean(process.env.DEBUG && process.env.DEBUG.includes('electron-forge'))
    };
    const runner = new _listr2.Listr([
        {
            title: 'Locating application',
            task: async (ctx)=>{
                const resolvedDir = await (0, _resolveDir).default(providedDir);
                if (!resolvedDir) {
                    throw new Error('Failed to locate startable Electron application');
                }
                ctx.dir = resolvedDir;
            }
        },
        {
            title: 'Loading configuration',
            task: async (ctx)=>{
                const { dir  } = ctx;
                ctx.forgeConfig = await (0, _forgeConfig).default(dir);
                ctx.packageJSON = await (0, _readPackageJson).readMutatedPackageJson(dir, ctx.forgeConfig);
                if (!ctx.packageJSON.version) {
                    throw new Error(`Please set your application's 'version' in '${dir}/package.json'.`);
                }
            }
        },
        {
            title: 'Rebuilding native modules',
            task: async ({ dir , forgeConfig , packageJSON  }, task)=>{
                await (0, _coreUtils).listrCompatibleRebuildHook(dir, await (0, _coreUtils).getElectronVersion(dir, packageJSON), platform, arch, forgeConfig.rebuildConfig, task);
            },
            options: {
                persistentOutput: true,
                bottomBar: Infinity,
                showTimer: true
            }
        },
        {
            title: 'Generating assets',
            task: async ({ forgeConfig  })=>{
                await (0, _hook).runHook(forgeConfig, 'generateAssets', platform, arch);
            }
        }, 
    ], listrOptions);
    await runner.run();
    const { dir: dir1 , forgeConfig: forgeConfig1 , packageJSON: packageJSON1  } = runner.ctx;
    let lastSpawned = null;
    const forgeSpawn = async ()=>{
        let electronExecPath = null;
        // If a plugin has taken over the start command let's stop here
        let spawnedPluginChild = await forgeConfig1.pluginInterface.overrideStartLogic({
            dir: dir1,
            appPath,
            interactive,
            enableLogging,
            args,
            runAsNode,
            inspect,
            inspectBrk
        });
        if (typeof spawnedPluginChild === 'object' && 'tasks' in spawnedPluginChild) {
            const innerRunner = new _listr2.Listr([], listrOptions);
            for (const task of spawnedPluginChild.tasks){
                innerRunner.add(task);
            }
            await innerRunner.run();
            spawnedPluginChild = spawnedPluginChild.result;
        }
        let prefixArgs = [];
        if (typeof spawnedPluginChild === 'string') {
            electronExecPath = spawnedPluginChild;
        } else if (Array.isArray(spawnedPluginChild)) {
            [electronExecPath, ...prefixArgs] = spawnedPluginChild;
        } else if (spawnedPluginChild) {
            await (0, _hook).runHook(forgeConfig1, 'postStart', spawnedPluginChild);
            return spawnedPluginChild;
        }
        if (!electronExecPath) {
            electronExecPath = await (0, _electronExecutable).default(dir1, packageJSON1);
        }
        d('Electron binary path:', electronExecPath);
        const spawnOpts = {
            cwd: dir1,
            stdio: 'inherit',
            env: {
                ...process.env,
                ...enableLogging ? {
                    ELECTRON_ENABLE_LOGGING: 'true',
                    ELECTRON_ENABLE_STACK_DUMPING: 'true'
                } : {}
            }
        };
        if (runAsNode) {
            spawnOpts.env.ELECTRON_RUN_AS_NODE = 'true';
        } else {
            delete spawnOpts.env.ELECTRON_RUN_AS_NODE;
        }
        if (inspect) {
            args = [
                '--inspect'
            ].concat(args);
        }
        if (inspectBrk) {
            args = [
                '--inspect-brk'
            ].concat(args);
        }
        const spawned = (0, _childProcess).spawn(electronExecPath, prefixArgs.concat([
            appPath
        ]).concat(args), spawnOpts);
        await (0, _hook).runHook(forgeConfig1, 'postStart', spawned);
        return spawned;
    };
    const forgeSpawnWrapper = async ()=>{
        const spawned = await forgeSpawn();
        // When the child app is closed we should stop listening for stdin
        if (spawned) {
            if (interactive && process.stdin.isPaused()) {
                process.stdin.resume();
            }
            spawned.on('exit', ()=>{
                if (spawned.restarted) {
                    return;
                }
                if (interactive && !process.stdin.isPaused()) {
                    process.stdin.pause();
                }
            });
        } else if (interactive && !process.stdin.isPaused()) {
            process.stdin.pause();
        }
        lastSpawned = spawned;
        return lastSpawned;
    };
    if (interactive) {
        process.stdin.on('data', async (data)=>{
            if (data.toString().trim() === 'rs' && lastSpawned) {
                console.info(_chalk.default.cyan('\nRestarting App\n'));
                lastSpawned.restarted = true;
                lastSpawned.kill('SIGTERM');
                lastSpawned.emit('restarted', await forgeSpawnWrapper());
            }
        });
        process.stdin.resume();
    }
    const spawned1 = await forgeSpawnWrapper();
    if (interactive) console.log('');
    return spawned1;
};
exports.default = _default;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvc3RhcnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3Bhd24sIFNwYXduT3B0aW9ucyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuXG5pbXBvcnQgeyBnZXRFbGVjdHJvblZlcnNpb24sIGxpc3RyQ29tcGF0aWJsZVJlYnVpbGRIb29rIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2NvcmUtdXRpbHMnO1xuaW1wb3J0IHsgRWxlY3Ryb25Qcm9jZXNzLCBGb3JnZUFyY2gsIEZvcmdlUGxhdGZvcm0sIFJlc29sdmVkRm9yZ2VDb25maWcsIFN0YXJ0T3B0aW9ucyB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgeyBMaXN0ciB9IGZyb20gJ2xpc3RyMic7XG5cbmltcG9ydCBsb2NhdGVFbGVjdHJvbkV4ZWN1dGFibGUgZnJvbSAnLi4vdXRpbC9lbGVjdHJvbi1leGVjdXRhYmxlJztcbmltcG9ydCBnZXRGb3JnZUNvbmZpZyBmcm9tICcuLi91dGlsL2ZvcmdlLWNvbmZpZyc7XG5pbXBvcnQgeyBydW5Ib29rIH0gZnJvbSAnLi4vdXRpbC9ob29rJztcbmltcG9ydCB7IHJlYWRNdXRhdGVkUGFja2FnZUpzb24gfSBmcm9tICcuLi91dGlsL3JlYWQtcGFja2FnZS1qc29uJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOnN0YXJ0Jyk7XG5cbmV4cG9ydCB7IFN0YXJ0T3B0aW9ucyB9O1xuXG50eXBlIFN0YXJ0Q29udGV4dCA9IHtcbiAgZGlyOiBzdHJpbmc7XG4gIGZvcmdlQ29uZmlnOiBSZXNvbHZlZEZvcmdlQ29uZmlnO1xuICBwYWNrYWdlSlNPTjogYW55O1xuICBzcGF3bmVkOiBFbGVjdHJvblByb2Nlc3M7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAoe1xuICBkaXI6IHByb3ZpZGVkRGlyID0gcHJvY2Vzcy5jd2QoKSxcbiAgYXBwUGF0aCA9ICcuJyxcbiAgaW50ZXJhY3RpdmUgPSBmYWxzZSxcbiAgZW5hYmxlTG9nZ2luZyA9IGZhbHNlLFxuICBhcmdzID0gW10sXG4gIHJ1bkFzTm9kZSA9IGZhbHNlLFxuICBpbnNwZWN0ID0gZmFsc2UsXG4gIGluc3BlY3RCcmsgPSBmYWxzZSxcbn06IFN0YXJ0T3B0aW9ucyk6IFByb21pc2U8RWxlY3Ryb25Qcm9jZXNzPiA9PiB7XG4gIGNvbnN0IHBsYXRmb3JtID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19wbGF0Zm9ybSB8fCBwcm9jZXNzLnBsYXRmb3JtO1xuICBjb25zdCBhcmNoID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19hcmNoIHx8IHByb2Nlc3MuYXJjaDtcbiAgY29uc3QgbGlzdHJPcHRpb25zID0ge1xuICAgIGNvbmN1cnJlbnQ6IGZhbHNlLFxuICAgIHJlbmRlcmVyT3B0aW9uczoge1xuICAgICAgY29sbGFwc2VFcnJvcnM6IGZhbHNlLFxuICAgIH0sXG4gICAgcmVuZGVyZXJTaWxlbnQ6ICFpbnRlcmFjdGl2ZSxcbiAgICByZW5kZXJlckZhbGxiYWNrOiBCb29sZWFuKHByb2Nlc3MuZW52LkRFQlVHICYmIHByb2Nlc3MuZW52LkRFQlVHLmluY2x1ZGVzKCdlbGVjdHJvbi1mb3JnZScpKSxcbiAgfTtcblxuICBjb25zdCBydW5uZXIgPSBuZXcgTGlzdHI8U3RhcnRDb250ZXh0PihcbiAgICBbXG4gICAgICB7XG4gICAgICAgIHRpdGxlOiAnTG9jYXRpbmcgYXBwbGljYXRpb24nLFxuICAgICAgICB0YXNrOiBhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgICAgY29uc3QgcmVzb2x2ZWREaXIgPSBhd2FpdCByZXNvbHZlRGlyKHByb3ZpZGVkRGlyKTtcbiAgICAgICAgICBpZiAoIXJlc29sdmVkRGlyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2NhdGUgc3RhcnRhYmxlIEVsZWN0cm9uIGFwcGxpY2F0aW9uJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGN0eC5kaXIgPSByZXNvbHZlZERpcjtcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHRpdGxlOiAnTG9hZGluZyBjb25maWd1cmF0aW9uJyxcbiAgICAgICAgdGFzazogYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgZGlyIH0gPSBjdHg7XG4gICAgICAgICAgY3R4LmZvcmdlQ29uZmlnID0gYXdhaXQgZ2V0Rm9yZ2VDb25maWcoZGlyKTtcbiAgICAgICAgICBjdHgucGFja2FnZUpTT04gPSBhd2FpdCByZWFkTXV0YXRlZFBhY2thZ2VKc29uKGRpciwgY3R4LmZvcmdlQ29uZmlnKTtcblxuICAgICAgICAgIGlmICghY3R4LnBhY2thZ2VKU09OLnZlcnNpb24pIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGxlYXNlIHNldCB5b3VyIGFwcGxpY2F0aW9uJ3MgJ3ZlcnNpb24nIGluICcke2Rpcn0vcGFja2FnZS5qc29uJy5gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0aXRsZTogJ1JlYnVpbGRpbmcgbmF0aXZlIG1vZHVsZXMnLFxuICAgICAgICB0YXNrOiBhc3luYyAoeyBkaXIsIGZvcmdlQ29uZmlnLCBwYWNrYWdlSlNPTiB9LCB0YXNrKSA9PiB7XG4gICAgICAgICAgYXdhaXQgbGlzdHJDb21wYXRpYmxlUmVidWlsZEhvb2soXG4gICAgICAgICAgICBkaXIsXG4gICAgICAgICAgICBhd2FpdCBnZXRFbGVjdHJvblZlcnNpb24oZGlyLCBwYWNrYWdlSlNPTiksXG4gICAgICAgICAgICBwbGF0Zm9ybSBhcyBGb3JnZVBsYXRmb3JtLFxuICAgICAgICAgICAgYXJjaCBhcyBGb3JnZUFyY2gsXG4gICAgICAgICAgICBmb3JnZUNvbmZpZy5yZWJ1aWxkQ29uZmlnLFxuICAgICAgICAgICAgdGFza1xuICAgICAgICAgICk7XG4gICAgICAgIH0sXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBwZXJzaXN0ZW50T3V0cHV0OiB0cnVlLFxuICAgICAgICAgIGJvdHRvbUJhcjogSW5maW5pdHksXG4gICAgICAgICAgc2hvd1RpbWVyOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdGl0bGU6ICdHZW5lcmF0aW5nIGFzc2V0cycsXG4gICAgICAgIHRhc2s6IGFzeW5jICh7IGZvcmdlQ29uZmlnIH0pID0+IHtcbiAgICAgICAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAnZ2VuZXJhdGVBc3NldHMnLCBwbGF0Zm9ybSwgYXJjaCk7XG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF0sXG4gICAgbGlzdHJPcHRpb25zXG4gICk7XG5cbiAgYXdhaXQgcnVubmVyLnJ1bigpO1xuXG4gIGNvbnN0IHsgZGlyLCBmb3JnZUNvbmZpZywgcGFja2FnZUpTT04gfSA9IHJ1bm5lci5jdHg7XG4gIGxldCBsYXN0U3Bhd25lZDogRWxlY3Ryb25Qcm9jZXNzIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3QgZm9yZ2VTcGF3biA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgZWxlY3Ryb25FeGVjUGF0aDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICAvLyBJZiBhIHBsdWdpbiBoYXMgdGFrZW4gb3ZlciB0aGUgc3RhcnQgY29tbWFuZCBsZXQncyBzdG9wIGhlcmVcbiAgICBsZXQgc3Bhd25lZFBsdWdpbkNoaWxkID0gYXdhaXQgZm9yZ2VDb25maWcucGx1Z2luSW50ZXJmYWNlLm92ZXJyaWRlU3RhcnRMb2dpYyh7XG4gICAgICBkaXIsXG4gICAgICBhcHBQYXRoLFxuICAgICAgaW50ZXJhY3RpdmUsXG4gICAgICBlbmFibGVMb2dnaW5nLFxuICAgICAgYXJncyxcbiAgICAgIHJ1bkFzTm9kZSxcbiAgICAgIGluc3BlY3QsXG4gICAgICBpbnNwZWN0QnJrLFxuICAgIH0pO1xuICAgIGlmICh0eXBlb2Ygc3Bhd25lZFBsdWdpbkNoaWxkID09PSAnb2JqZWN0JyAmJiAndGFza3MnIGluIHNwYXduZWRQbHVnaW5DaGlsZCkge1xuICAgICAgY29uc3QgaW5uZXJSdW5uZXIgPSBuZXcgTGlzdHIoW10sIGxpc3RyT3B0aW9ucyk7XG4gICAgICBmb3IgKGNvbnN0IHRhc2sgb2Ygc3Bhd25lZFBsdWdpbkNoaWxkLnRhc2tzKSB7XG4gICAgICAgIGlubmVyUnVubmVyLmFkZCh0YXNrKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IGlubmVyUnVubmVyLnJ1bigpO1xuICAgICAgc3Bhd25lZFBsdWdpbkNoaWxkID0gc3Bhd25lZFBsdWdpbkNoaWxkLnJlc3VsdDtcbiAgICB9XG4gICAgbGV0IHByZWZpeEFyZ3M6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHR5cGVvZiBzcGF3bmVkUGx1Z2luQ2hpbGQgPT09ICdzdHJpbmcnKSB7XG4gICAgICBlbGVjdHJvbkV4ZWNQYXRoID0gc3Bhd25lZFBsdWdpbkNoaWxkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzcGF3bmVkUGx1Z2luQ2hpbGQpKSB7XG4gICAgICBbZWxlY3Ryb25FeGVjUGF0aCwgLi4ucHJlZml4QXJnc10gPSBzcGF3bmVkUGx1Z2luQ2hpbGQ7XG4gICAgfSBlbHNlIGlmIChzcGF3bmVkUGx1Z2luQ2hpbGQpIHtcbiAgICAgIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwb3N0U3RhcnQnLCBzcGF3bmVkUGx1Z2luQ2hpbGQpO1xuICAgICAgcmV0dXJuIHNwYXduZWRQbHVnaW5DaGlsZDtcbiAgICB9XG5cbiAgICBpZiAoIWVsZWN0cm9uRXhlY1BhdGgpIHtcbiAgICAgIGVsZWN0cm9uRXhlY1BhdGggPSBhd2FpdCBsb2NhdGVFbGVjdHJvbkV4ZWN1dGFibGUoZGlyLCBwYWNrYWdlSlNPTik7XG4gICAgfVxuXG4gICAgZCgnRWxlY3Ryb24gYmluYXJ5IHBhdGg6JywgZWxlY3Ryb25FeGVjUGF0aCk7XG5cbiAgICBjb25zdCBzcGF3bk9wdHMgPSB7XG4gICAgICBjd2Q6IGRpcixcbiAgICAgIHN0ZGlvOiAnaW5oZXJpdCcsXG4gICAgICBlbnY6IHtcbiAgICAgICAgLi4ucHJvY2Vzcy5lbnYsXG4gICAgICAgIC4uLihlbmFibGVMb2dnaW5nXG4gICAgICAgICAgPyB7XG4gICAgICAgICAgICAgIEVMRUNUUk9OX0VOQUJMRV9MT0dHSU5HOiAndHJ1ZScsXG4gICAgICAgICAgICAgIEVMRUNUUk9OX0VOQUJMRV9TVEFDS19EVU1QSU5HOiAndHJ1ZScsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgOiB7fSksXG4gICAgICB9IGFzIE5vZGVKUy5Qcm9jZXNzRW52LFxuICAgIH07XG5cbiAgICBpZiAocnVuQXNOb2RlKSB7XG4gICAgICBzcGF3bk9wdHMuZW52LkVMRUNUUk9OX1JVTl9BU19OT0RFID0gJ3RydWUnO1xuICAgIH0gZWxzZSB7XG4gICAgICBkZWxldGUgc3Bhd25PcHRzLmVudi5FTEVDVFJPTl9SVU5fQVNfTk9ERTtcbiAgICB9XG5cbiAgICBpZiAoaW5zcGVjdCkge1xuICAgICAgYXJncyA9IFsnLS1pbnNwZWN0JyBhcyBzdHJpbmcgfCBudW1iZXJdLmNvbmNhdChhcmdzKTtcbiAgICB9XG4gICAgaWYgKGluc3BlY3RCcmspIHtcbiAgICAgIGFyZ3MgPSBbJy0taW5zcGVjdC1icmsnIGFzIHN0cmluZyB8IG51bWJlcl0uY29uY2F0KGFyZ3MpO1xuICAgIH1cblxuICAgIGNvbnN0IHNwYXduZWQgPSBzcGF3bihcbiAgICAgIGVsZWN0cm9uRXhlY1BhdGghLCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIHByZWZpeEFyZ3MuY29uY2F0KFthcHBQYXRoXSkuY29uY2F0KGFyZ3MgYXMgc3RyaW5nW10pLFxuICAgICAgc3Bhd25PcHRzIGFzIFNwYXduT3B0aW9uc1xuICAgICkgYXMgRWxlY3Ryb25Qcm9jZXNzO1xuXG4gICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RTdGFydCcsIHNwYXduZWQpO1xuICAgIHJldHVybiBzcGF3bmVkO1xuICB9O1xuXG4gIGNvbnN0IGZvcmdlU3Bhd25XcmFwcGVyID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHNwYXduZWQgPSBhd2FpdCBmb3JnZVNwYXduKCk7XG4gICAgLy8gV2hlbiB0aGUgY2hpbGQgYXBwIGlzIGNsb3NlZCB3ZSBzaG91bGQgc3RvcCBsaXN0ZW5pbmcgZm9yIHN0ZGluXG4gICAgaWYgKHNwYXduZWQpIHtcbiAgICAgIGlmIChpbnRlcmFjdGl2ZSAmJiBwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHtcbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcbiAgICAgIH1cbiAgICAgIHNwYXduZWQub24oJ2V4aXQnLCAoKSA9PiB7XG4gICAgICAgIGlmIChzcGF3bmVkLnJlc3RhcnRlZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbnRlcmFjdGl2ZSAmJiAhcHJvY2Vzcy5zdGRpbi5pc1BhdXNlZCgpKSB7XG4gICAgICAgICAgcHJvY2Vzcy5zdGRpbi5wYXVzZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGludGVyYWN0aXZlICYmICFwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHtcbiAgICAgIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTtcbiAgICB9XG5cbiAgICBsYXN0U3Bhd25lZCA9IHNwYXduZWQ7XG4gICAgcmV0dXJuIGxhc3RTcGF3bmVkO1xuICB9O1xuXG4gIGlmIChpbnRlcmFjdGl2ZSkge1xuICAgIHByb2Nlc3Muc3RkaW4ub24oJ2RhdGEnLCBhc3luYyAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEudG9TdHJpbmcoKS50cmltKCkgPT09ICdycycgJiYgbGFzdFNwYXduZWQpIHtcbiAgICAgICAgY29uc29sZS5pbmZvKGNoYWxrLmN5YW4oJ1xcblJlc3RhcnRpbmcgQXBwXFxuJykpO1xuICAgICAgICBsYXN0U3Bhd25lZC5yZXN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICBsYXN0U3Bhd25lZC5raWxsKCdTSUdURVJNJyk7XG4gICAgICAgIGxhc3RTcGF3bmVkLmVtaXQoJ3Jlc3RhcnRlZCcsIGF3YWl0IGZvcmdlU3Bhd25XcmFwcGVyKCkpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHByb2Nlc3Muc3RkaW4ucmVzdW1lKCk7XG4gIH1cblxuICBjb25zdCBzcGF3bmVkID0gYXdhaXQgZm9yZ2VTcGF3bldyYXBwZXIoKTtcblxuICBpZiAoaW50ZXJhY3RpdmUpIGNvbnNvbGUubG9nKCcnKTtcblxuICByZXR1cm4gc3Bhd25lZDtcbn07XG4iXSwibmFtZXMiOlsiU3RhcnRPcHRpb25zIiwiZCIsImRlYnVnIiwiZGlyIiwicHJvdmlkZWREaXIiLCJwcm9jZXNzIiwiY3dkIiwiYXBwUGF0aCIsImludGVyYWN0aXZlIiwiZW5hYmxlTG9nZ2luZyIsImFyZ3MiLCJydW5Bc05vZGUiLCJpbnNwZWN0IiwiaW5zcGVjdEJyayIsInBsYXRmb3JtIiwiZW52IiwibnBtX2NvbmZpZ19wbGF0Zm9ybSIsImFyY2giLCJucG1fY29uZmlnX2FyY2giLCJsaXN0ck9wdGlvbnMiLCJjb25jdXJyZW50IiwicmVuZGVyZXJPcHRpb25zIiwiY29sbGFwc2VFcnJvcnMiLCJyZW5kZXJlclNpbGVudCIsInJlbmRlcmVyRmFsbGJhY2siLCJCb29sZWFuIiwiREVCVUciLCJpbmNsdWRlcyIsInJ1bm5lciIsIkxpc3RyIiwidGl0bGUiLCJ0YXNrIiwiY3R4IiwicmVzb2x2ZWREaXIiLCJyZXNvbHZlRGlyIiwiRXJyb3IiLCJmb3JnZUNvbmZpZyIsImdldEZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJyZWFkTXV0YXRlZFBhY2thZ2VKc29uIiwidmVyc2lvbiIsImxpc3RyQ29tcGF0aWJsZVJlYnVpbGRIb29rIiwiZ2V0RWxlY3Ryb25WZXJzaW9uIiwicmVidWlsZENvbmZpZyIsIm9wdGlvbnMiLCJwZXJzaXN0ZW50T3V0cHV0IiwiYm90dG9tQmFyIiwiSW5maW5pdHkiLCJzaG93VGltZXIiLCJydW5Ib29rIiwicnVuIiwibGFzdFNwYXduZWQiLCJmb3JnZVNwYXduIiwiZWxlY3Ryb25FeGVjUGF0aCIsInNwYXduZWRQbHVnaW5DaGlsZCIsInBsdWdpbkludGVyZmFjZSIsIm92ZXJyaWRlU3RhcnRMb2dpYyIsImlubmVyUnVubmVyIiwidGFza3MiLCJhZGQiLCJyZXN1bHQiLCJwcmVmaXhBcmdzIiwiQXJyYXkiLCJpc0FycmF5IiwibG9jYXRlRWxlY3Ryb25FeGVjdXRhYmxlIiwic3Bhd25PcHRzIiwic3RkaW8iLCJFTEVDVFJPTl9FTkFCTEVfTE9HR0lORyIsIkVMRUNUUk9OX0VOQUJMRV9TVEFDS19EVU1QSU5HIiwiRUxFQ1RST05fUlVOX0FTX05PREUiLCJjb25jYXQiLCJzcGF3bmVkIiwic3Bhd24iLCJmb3JnZVNwYXduV3JhcHBlciIsInN0ZGluIiwiaXNQYXVzZWQiLCJyZXN1bWUiLCJvbiIsInJlc3RhcnRlZCIsInBhdXNlIiwiZGF0YSIsInRvU3RyaW5nIiwidHJpbSIsImNvbnNvbGUiLCJpbmZvIiwiY2hhbGsiLCJjeWFuIiwia2lsbCIsImVtaXQiLCJsb2ciXSwibWFwcGluZ3MiOiI7Ozs7K0JBZ0JTQSxDQUFZOzs7ZUFBWkEsWUFBWTs7OztBQWhCZSxHQUFlLENBQWYsYUFBZTtBQUVZLEdBQTRCLENBQTVCLFVBQTRCO0FBQ0UsR0FBOEIsQ0FBOUIsWUFBOEI7QUFDekcsR0FBTyxDQUFQLE1BQU87QUFDUCxHQUFPLENBQVAsTUFBTztBQUNILEdBQVEsQ0FBUixPQUFRO0FBRU8sR0FBNkIsQ0FBN0IsbUJBQTZCO0FBQ3ZDLEdBQXNCLENBQXRCLFlBQXNCO0FBQ3pCLEdBQWMsQ0FBZCxLQUFjO0FBQ0MsR0FBMkIsQ0FBM0IsZ0JBQTJCO0FBQzNDLEdBQXFCLENBQXJCLFdBQXFCOzs7Ozs7QUFFNUMsS0FBSyxD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